const { MongoClient } = require('mongodb');
const config = require('../config');

const URL = config.mongoDB.url;
let DBConnection = null; // Ð¥Ñ€Ð°Ð½Ð¸Ð¼ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð² Ð¿Ð°Ð¼ÑÑ‚Ð¸

async function initDb() {
	if (DBConnection) {
		console.log('ðŸ“¦ Ð£Ð¶Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ðº MongoDB');
		return;
	}

	try {
		const client = new MongoClient(URL, {
			useNewUrlParser: true,
			useUnifiedTopology: true,
		});
		await client.connect();
		DBConnection = client.db();
		console.log('âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº MongoDB');
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº MongoDB:', err);
		process.exit(1); // Ð—Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€
	}
}

async function addMessageToDb(message, collectionName) {
	if (!DBConnection) throw new Error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');
	const collection = DBConnection.collection(collectionName);

	try {
		// Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹
		const document = {
			chatId: message.chatId,
			messageId: message.messageId,
			fileId: message.fileId || null, // Ð•ÑÐ»Ð¸ fileId Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ null
			caption: '#Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐºÐ°', // Ð•ÑÐ»Ð¸ caption Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÑƒÑÑ‚ÑƒÑŽ ÑÑ‚Ñ€Ð¾ÐºÑƒ
			createdAt: new Date(), // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ
		};

		// Ð’ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ
		const result = await collection.insertOne(document);
		console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ñ ID: ${result.insertedId}`);
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', err);
	}
}

// ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð´Ð½Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
async function getMessageFromDb(collectionName) {
	if (!DBConnection) throw new Error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');
	const collection = DBConnection.collection(collectionName);
	try {
		// ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ ÑÐ°Ð¼Ð¾Ðµ ÑÑ‚Ð°Ñ€Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
		const message = await collection.findOne({}, { sort: { createdAt: 1 } });

		if (!message) {
			console.log('ÐÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸');
			return null;
		}

		// Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
		await collection.deleteOne({ _id: message._id });
		console.log(`Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ${message._id} ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…`);

		return message;
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', err);
		return null;
	}
}

// Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
async function deleteMessageFromDb(messageId, collectionName) {
	if (!DBConnection) throw new Error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');
	const collection = DBConnection.collection(collectionName);
	try {
		await collection.deleteOne({ id: messageId });
		console.log(`âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ ${messageId} ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾ Ð¸Ð· Ð±Ð°Ð·Ñ‹`);
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', err);
	}
}

async function addPinToDb(id, collection) {
	if (!DBConnection) throw new Error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');

	const myColl = DBConnection.collection(collection);
	try {
		const result = await myColl.insertOne({ id });
		console.log(`âœ… ÐŸÐ¸Ð½ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² Ð±Ð°Ð·Ñƒ: ${result.insertedId}`);
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¸Ð½Ð°:', err);
	}
}

async function writeAllPinsFromDb(collection) {
	if (!DBConnection) throw new Error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð°');

	const myColl = DBConnection.collection(collection);
	try {
		return await myColl.find().toArray();
	} catch (err) {
		console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ð¸Ð½Ð¾Ð² Ð¸Ð· Ð±Ð°Ð·Ñ‹:', err);
		return [];
	}
}

module.exports = {
	initDb,
	addPinToDb,
	writeAllPinsFromDb,
	getDb: () => DBConnection,
	addMessageToDb,
	getMessageFromDb,
	deleteMessageFromDb,
};
